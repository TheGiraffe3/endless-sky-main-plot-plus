mission "Neutrality 1"
    deadline 0
    invisible
    to offer
        "year" >= 3023
        not "chosen sides"
    source
        government "Republic" "Syndicate" "Free Worlds"
    on offer
        conversation
            `As you enter the bar, a man approaches you.`
            `"So, about that war between the Free Worlds and the Republic. Whose side are you on?"`
            label "whose side are you on"
            choice
                `"The Free Worlds!"`
                    goto "free worlds"
                `"The Republic!"`
                    goto "republic"
                `"The Syndicate!"`
                    goto "syndicate"
                `"Actually, none of them."`
                    goto "neutral"
                    to display
                        not "claimed neutrality"
                `No, I really am neutral.`
                    to display
                        has "claimed neutrality"
                `(Go someplace else)`
                    decline

            action
                event "pug notice neutrality" 5
            `"Huh. Well, I admire your resolve. Can't go wrong with that."`
                goto "end"

            label "free worlds"
            `"You support freedom and equality, eh? I prefer the Republic's order and stability."`
                goto "end"

            label "republic"
            `"You support order and stability, eh? So do I, so do I."`
                goto "end"

            label "syndicate"
            `"You support free markets and wealth, eh? Nothing wrong with that."`
                goto "end"

            label "neutral"
            action
                set "claimed neutrality"
            `The main looks taken aback.`
            `"No sides, eh? You have to pick a side!"`
                goto "whose side are you on"

            label "end"
            action
                clear "claimed neutrality"
            `The man leaves without another word.`
                decline

event "pug notice neutrality"

mission "Neutrality 2"
    invisible
    landing
    clearance "For some reason, the spaceport controller lets you land."
    to offer
        has "event: pug notice neutrality"
        or
            has "pug reputation override"
            not "reputation: Pug" < 0
    source
        system "Zeta Aquilae" "Rasalhague" "Orvala" "Vega" "Altair" "Delta Capricorni" "Alderamin"
    destination "Pugglequat"
    to complete
        never
    on offer
        conversation
            `As you try to land on <origin>, your ship throws a strange error message and starts moving away from the spaceport.`
            choice
                `(Try to regain control)`
                `(Don't try to regain control)`
                    goto "remote landing"

            `You try to regain control of your ship manually, but it doesn't respond to your inputs.`

            label "remote landing"
            `Your ship comes to a stop in a remote location.`
            # Paraphrased from descriptions of the Pug in "FWC Pug 2C" from the the "free worlds 3 checkmate.txt" file in endless sky.
            `Shortly after, strange, yellow, alien ships uncloak next to you. But it's what comes out of these ships that's really weird: pale aliens with strange proportions, large heads, and long arms and legs compared to their short, cylindrical torsoes. As they walk towards your ship, their gait appears somewhat similar to that of insects.`
            `"So you don't want to fight your war?" asks one of the aliens.`

            label "are you neutral"
            choice
                `"No."`
                    goto "neutral"
                `"Actually, yes."`
                    goto "changed mind"
                `"It's not my war."`
                    to display
                        not "neutral: war independent"

            action
                set "neutral: war independent"
            `"Oh, but it is. Just because you aren't actually fighting doesn't make it not your war. So, will you fight, or not?"`
                goto "are you neutral"

            label "changed mind"
            action
                set "not neutral"
            `"That's not what it seemed like to us. If that is really the case, we have no use here."`
            `The aliens depart. Your ship stops throwing the error message and also lets you depart.`
                flee

            label "neutral"
            action
                "reputation: Pug" >?= 0
            # The Pug refer to nukes as "weapons of genocide" in "FWC Pug 2C" from the the "free worlds 3 checkmate.txt" file in endless sky.
            `"We have been monitoring your species closely, as there have been some unsettling developments. We noticed that you had resumed your use of nuclear weapons, weapons of genocide. We are glad that you have chosen the side of peace."`

            choice
                `"Who are you?"`
                    goto "pug"
                `"I wasn't the one who dropped nuclear weapons."`
                    to display
                        not "neutral: nuke independent"

            action
                set "neutral: nuke independent"
            `"And yet you have made no effort to discover who did."`
                to display
                    not "FW Katya 3: done"
            `"And yet you have made little effort to discover who did."`
                to display
                    has "FW Katya 3: done"
            choice
                `"Who are you?"`

            label "pug"
            `"We are Pug. Our goal is to bring peace and prevent your species from inflicting significant harm upon itself."`

            label "staff"
            action
                clear "neutral: nuke independent"
                clear "neutral: war independent"

            `"Your decision to avoid war is honorable, so we shall honor it."`
            `Without another word, a Pug rushes towards you and hits you with its staff. Everything blacks out.`
                accept


mission "Neutrality 2b"
    invisible
    landing
    clearance "For some reason, the spaceport controller lets you land."
    to offer
        has "event: pug notice neutrality"
        or
            has "pug reputation override"
            not "reputation: Pug" < 0
    to accept
        not "not neutral"
    source
        system "Zeta Aquilae" "Rasalhague" "Orvala" "Vega" "Altair" "Delta Capricorni" "Alderamin"
    destination "Pugglemug"
    to complete
        never
    on offer
        clear "pug reputation override"
        conversation
            # Adapted from the Ruin: Landing mission in endless sky, with major parts of the description copied.
            `You wake up inside of a tank, with an insectoid robot removing the lid. You step out onto an abandoned fueling depot: a ring of landing pads around a cluster of tanks of all different shapes and sizes. Some of them must be cyrogenic, because they are covered in ice. A few other slow-moving insectoid robots are busy clearing off the ice and cleaning the tanks, but they do not appear to be armed and you see no sign of any other creatures or of any defense systems. From the fact that some of the tanks are covered in frost and others are not, you would guess that each one, besides the one you were in, contains a different fuel, as each tank besides yours has dozens of different connectors branching off from it. You find your ship parked nearby, and with surprise, you discover that it is connected to one of the tanks, and the connector is the style used in human space. Other than the robots and the fog swirling in the valley below you, there is no sign of life or motion here, and the air is uncomfortably moist and cold despite the hot steam rising up from a few nearby vents in the ground.`
            `You power on your ship. When you look at your ship's clock, you notice that several years have passed, any time sensitive missions you may have had have been failed, and you have automatically received tribute and paid necessary salaries. It seems like you have been gone for much longer than you realized...`
                accept
    on accept
        log "Interacted with aliens who call themselves the Pug, and met with some of them, then got kidnapped for what looks like several years. Was likely placed in a cyrogenic tank. The Pug say that they want to bring peace and protect humanity from excessive self-harm."
        log "Factions" "Pug" `The Pug are aliens with barrel-shaped bodies and spindly legs. They claim their goals are to bring humanity peace and protect humanity from excessive self-harm.`
        # Requires relocate mission PR
        # relocate
        #     "flagship only"
        #     location
        #         Ruin

        # Requires time travel
        # "pass days" 1500
        # OR
        # "year" += 4

        set "chosen sides"
        event "recapture of Kornephoros"
        event "fw zug expansion complete"
        event "oathkeepers founded"
        event "Tarazed neutrality"
        event "syndicate assistance"
        event "syndicate convoys to Tarazed"
        event "tarazed assistance"
        event "fw dirt belt patrols"
        event "plasma turret available"
        set "plasma turret available: done"
        event "fw conservatory founded"
        event "Thule becomes independent"
        event "Greenrock recovered"
        event "flamethrower available"
        event "navy occupying the south"
        event "catalytic ramscoop available"
        event "fw gets catalytic ramscoop"
        event "navy using mark ii ships"
        event "fw southern expansion"
        event "fw occupying the north"
        event "fw northern expansion"
        event "alphas capture Poisonwood"
        event "liberation of Poisonwood"
        event "Poisonwood description patch"
        event "death of nguyen"
        event "dreadnoughts for sale"
        event "dreadnought deployment"
        event "bloodsea joins free worlds"
        event "bloodsea spaceport completed"
        event "albatross joins free worlds"
        event "fw expanded and cut"
        event "fw tarazed republic"
        event "deep sky tech available"
        event "navy out of rastaban"
        event "stack core for sale"
        event "fwc southern liberation"
        event "fwc capture kaus borealis"
        event "fwc capture cebalrai"
        event "fwc defended cebalrai"
        event "fwc capture menkent"
        event "fwc navy retakes cebalrai (patched)"
        event "fwc pug invasion"
        event "fw armistice"
        event "reputation patch"
        event "fwc battle for rasalhague"
        event "fwc liberation of rasalhague"
        event "fwc reconnect ascella"
        event "fwc reconnect zeta aquilae"
        event "fwc liberation of vega"
        event "fwc reconnect vega"
        event "fwc link restoration 1"
        event "fwc link restoration 2"
        event "fwc link restoration 3"
        event "pug flee"
        # patch because this plugin depends on the wormhole linking to the pleaides
        # the 1 is to prevent race conditions by ensuring it happens after 'pug flee'
        event "pug flee (patched)" 1
        event "fwc pug defeated"
        event "syndicate tech available"

        # This is merged with this mission so no need to offer it twice.
        set "Ruin: Landing: offered"

        # Missions in the FW campaign based on the events
        set "oathkeepers founded: offered"
        set "FW Southern Break Ends: offered"
        set "FW Diplomacy 1: offered"
        set "FW Death of Nguyen: offered"
        set "plasma turret available: offered"
        set "FW Flamethrower 1: offered"
        set "FW Stack Core 1C: offered"

        # Missions in Crisis in Management based on the events
        set "oathkeepers founded (non-FW): offered"
        set "event: Kornephoros (non-FW): offered"
    on enter
        # As seen above/below, a lot of this makes no sense without two PRs being implemented. However, I am keeping this here for later. For now, use your imagination.
        dialog `Parts of this mission are dependent on future content which has not yet been released. To continue the campaign, please head to the planet 'Deneb' which should now be linked to the system you are in. It will assume you came from a wormhole and that a lot of time has passed, which will happen once the future content gets released.`
    on enter Deneb
        dialog `This appears to be a system in the middle of human space, just one jump away from where you were kidnapped, yet it is now linked to the rest of human space. You should probably land one of the two planets and try to figure out what is going on.`


mission "Neutrality 3"
    invisible
    # alt first last's home planet isn't dependent on what planets will let you land
    ignore clearance
    to offer
        has "Neutrality 2b: active"
    source
        system Deneb
    # For alt first last's home planet
    destination
        attributes "dirt belt"
        attributes "shipyard"
        not
            planet "New Boston"
    on offer
        # The end part of log entries was taken from log entries in "FWC Pug 6" from the the "free worlds 3 checkmate.txt" file in endless sky.
        log "It turns out the Pug invaded human space and cut neighboring hyperlinks, using the same claims about peace and protecting humanity as their justification for their invasion. The Free Worlds had nuclear weapons, which were no match for the Pug. Then, a Free Worlds captain was able to steal one of their 'jump drives', arouse the Navy, and restore hyperlinks. At least, that's what a receptionist on what used to be one their planets said when asked about it. It is possible that the true purpose of the Pug attack was to give human beings a common enemy that would force them to band together and forget their internal struggles."
        log "Factions" "Pug" "The Pug invaded human space and cut neighboring hyperlinks, using the same claims about peace and protecting humanity as their justification for their invasion. They were able to defeat a nuclear armed fleet, but a brave Free Worlds captain was able to steal one of their drives and reconnected the hyperspace lanes. When the Free Worlds and the Navy banded together to attack them, they disappeared into a wormhole, which goes to the planet the Pug released you onto. It is possible that the true purpose of their attack was to give human beings a common enemy that would force them to band together and forget their internal struggles."
        log "Factions" "Free Worlds" "During the war with the Pug, the Free Worlds had nuclear weapons. It is likely that this isn't the first time that they used them. After the Pug war, the Free Worlds was granted autonomy by the Republic."
        conversation
            `You decide to checkout the spaceport anyways, which looks just as alien as the rest of the planet. You approach what appears to be <origin>'s information kiosk, which looks significantly less alien.`
                to display
                    not "Neutrality 3b: declined"
            `Entering the spaceport, which looks just as alien as the rest of the planet, you approach what appears to be <origin>'s information kiosk, which looks significantly less alien.`
                to display
                    has "Neutrality 3b: declined"
            `"How can I help you?" asks the receptionist.`
            label "help"
            choice
                `"Why are there humans on an alien planet?"`
                `"Why were people gesturing towards the sky as I landed?"`
                `"Why did the spaceport controller let me land?"`

            `"Wait, are you Captain <last>? We had reports of a vessel associated with you coming from the wormhole," they explain, "and for several years, your ship appears to have not requested to land on any planet. Someone probably spread the word around to look for a ship looking like yours. What's going on?"`
            choice
                `"I was going to ask you the same thing. Why are there people on an alien planet?"`
                `"I was abducted by aliens who call themselves the Pug."`
                    goto "abducted"
                `"It's a long story."`

            `"Does this have something to do with the Pug?"`
            choice
                `"Actually, it does. They abducted me."`
                `"How do you know about the Pug?"`
                    goto "pug"

            label "abducted"
            `"Really? The ones who invaded human space?"`
            choice
                `"They invaded human space?"`
                `"They told me they wanted to preserve peace."`
                    goto "peace"

            `"Oh right, you probably don't know about that."`
                goto "pug"

            label "peace"
            `"That's what they said when they annexed Silver."`

            label "pug"
            `"The Pug attacked Silver, claiming that they were there to end the war and bring peace. They cut the hyperspace links from the other planets and connected them to this system instead. A few tried to resist, but not even the Free Worlds, with their nuclear weapons, were successful. At least, not at first. <last> <first>, a brave captain from <planet>, who was a member of the Free Worlds council, stole a jump drive from them, like those that the Quarg use, that let them bypass hyperlanes. With this, they roused the Navy, reconnected the hyperspace lanes, and helped chase the Pug fleet back to this system!  But when they got here, the Pug were gone, with that wormhole you came from in its place. Now the Free Worlds and the Republic are no longer at war, with the Free Worlds an autonomous part of the Republic, like the Syndicate. At least, that is what I have been told. Maybe that's what the Pug meant by 'peace.'"`
            `The receptionist pauses. "I'm not assuming they told you anything."`
            `"Not much," you admit.`
            `"By the way, considering you didn't know about the Pug invasion, you might also not know about the new technology humanity has developed during the war. If so, you should probably speak to officials at the main outposts of Deep Sky Technology, Kraz Cybernetics, and Syndicated Systems for more information. They can be found on the planets Asgard in the Naos system, Rust in the Kraz system, and Hephaestus in the Markab system, respectively."`
            `You thank the receptionist and head on your way, now knowing at least a little bit about what happened while you were gone, and preparing to learn a little more.`
                decline
    on decline
        fail "Neutrality 2"
        fail "Neutrality 2b"


# The "Neutrality 3a" and "Neutrality 3b" missions were adapted from "FWC Pug 2B: Pugglequat" from the "free worlds 3 checkmate.txt" file in endless sky.

mission "Neutrality 3a"
    invisible
    landing
    to offer
        has "Neutrality 2b: active"
        not "Neutrality 3: offered"
    source
        system Deneb
    on offer
        conversation
            branch "pugglequat"
                has "flagship planet: Pugglequat"
            action
                set "neutrality: pugglemug first"
            branch "end"
                has "flagship planet: Pugglemug"
            label "pugglequat"
            action
                set "neutrality: pugglequat first"
            label "end"
            `This planet was clearly one of the native Pug worlds. The architecture is entirely alien, yet you see people working here. As you land, you see people gesturing towards the sky, perhaps as a way of indicating that you should visit the other inhabited planet in this system.`
                decline

mission "Neutrality 3b"
    invisible
    landing
    to offer
        has "Neutrality 3a: declined"
        not "Neutrality 3: offered"
        or
            and
                has "flagship planet: Pugglemug"
                not "neutrality: pugglemug first"
            and
                has "flagship planet: Pugglequat"
                not "neutrality: pugglequat first"
    source
        system Deneb
    on offer
        conversation
            `This planet was also clearly one of the native Pug worlds. Once again, architecture is entirely alien, yet you see people working here. As you land, you see more people gesturing towards the sky. Maybe this doesn't have to do with which planet you should visit. You should probably check the spaceport to see what is going on.`
                decline

mission "Neutrality 4"
    invisible
    to offer
        has "Neutrality 2b: active"
    to fail
        has "Neutrality 4: Free Worlds: done"
        has "Neutrality 4: Syndicate: done"
        has "Neutrality 4: Deep: done"
    source
        system Deneb
    on fail
        # Nukes require the militia license so you can't actually get them
        event "fwc solace has augmented nukes"
        event "fwc navy occupies alcyone"
        event "fwc navy done with alcyone" 50

        set "skipped main plot"
        set "main plot completed"
        set "free worlds checkmate"

        # Disable Hai Reveal, for now, as it's broken when not siding with the free worlds anyways.
        set "Hai Reveal: Secret Leaks: offered"
        set "Hai Reveal: Secret Leaks: Hai: offered"

        # Disable Wanderers Truce Check, for now, as I have no clue how to fix the Danforth problem.
        set "Wanderers: Truce Check: offered"
        set "Wanderers: Jump Drive Source: offered"

mission "Neutrality 4: Free Worlds"
    name "Visit Kraz Cybernetics"
    description "Visit the main Kraz Cybernetics outfitter at <destination> to learn about new technology developed by the Free Worlds."
    to offer
        has "Neutrality 2b: active"
    to complete
        never
    to fail
        has "Neutrality 4b: Free Worlds: declined"
    source
        system Deneb
    destination Rust

mission "Neutrality 4b: Free Worlds"
    invisible
    outfitter
    to offer
        has "Neutrality 4: Free Worlds: active"
    source Rust
    on offer
        log "Factions" "Free Worlds" "During the civil war, the Free Worlds produced two new heat related weapons. The first is a plasma turret, which is simply a plasma cannon mounted on a turret. The second is a flamethrower, which can quickly overheat a ship, but requires hyperspace fuel and works best when directly on top of it."
        conversation
            `The main outfitter of Kraz Cybernetics, instead of having employees, only consists of a row of computers.`
            `You approach an unoccupied computer. On the screen it says, "Please scan your pilot's license."`
            choice
                `(Scan your pilot's license)`
            `Scanning your pilot's license involves holding it up to a camera above the computer. Upon scanning your pilot's license, you see a panel of outfits next to a box that says "nothing selected."`
            # Literally a screenshot of the Kraz outfitter in the game
            scene "scene/outfitter"
            `Reading through the outfit descriptions, two of them catch your eye.`
            # Taken from the actual outfit descriptions of the plasma turret and flamethrower, with additions describing history
            scene "outfit/plasma turret"
            `"The Plasma Turret is a pair of Plasma Cannons mounted on a turret so that they can fire in any direction. It is a fearsome weapon, but only the largest of ships have the space and the energy that it requires. It was developed by Kraz Cybernetics during the civil war."`
            scene "outfit/flamethrower"
            `"A crude but impressive-looking weapon, the Flamethrower ignites your hyperspace fuel and directs a stream of it towards your adversaries. The damage it does is relatively minor, but it can be useful for causing a target that is already operating near its thermal capacity to overheat, temporarily taking it out of the fight. It was developed by Kraz Cybernetics during the civil war."`

            `Searching through the rest of the outfitter's catalog, you don't notice any other similar outfits.`
                decline


mission "Neutrality 4: Syndicate"
    name "Visit Syndicated Systems"
    description "Visit the main Syndicated Systems outfitter at <destination> to learn about new technology developed by the Syndicate."
    landing
    to offer
        has "Neutrality 2b: active"
    to complete
        never
    to fail
        has "Neutrality 4b: Syndicate: declined"
    source
        system Deneb
    destination Hephaestus

mission "Neutrality 4b: Syndicate"
    invisible
    outfitter
    to offer
        has "Neutrality 4: Syndicate: active"
    source Hephaestus
    on offer
        log "Factions" "Syndicate" "During the civil war, the Syndicate produced a new S line of regenerators, which save outfit space but require additional power and cooling to compensate. They also produced ionic afterburners, which like regular afterburners, but are much more fuel and space efficient."
        conversation
            `The Syndicated Systems help desk consists of a long row of booths in front of an even longer line of people, above a sign saying "Quality Assurance." As you near the front of the line, you overhear a fight break out between one of the customers and a quality assurance agent.`
            `"This Protector is a piece of junk!"`
            `"We don't sell the Protector. That's Syndicated Shipyards."`
            `"When I went to Syndicated Shipyards, they said it was an 'engine problem' and said to speak to you!"`
            `"I'm sorry. If you have problems with Syndicated Shipyards, you have to speak to their quality assurance, not us."`
            `"Argh!"`
            `You can't hear more, because a Syndicate employee ushers you to one of the booths. Behind it is a somewhat exasperated looking employee.`
            `"How can I help you?"`
            choice
                `"I want to learn more about Syndicated Systems' new outfits."`
                `"I heard that Syndicated Systems has developed new technology, and I want to learn more about it."`
                `"Can you talk to me about the new outfits developed by Syndicated Systems?"`
            `After taking a few deep breaths, the Quality Assurance agent then proceeds to recite what sounds like a scripted message.`
            `"During the war, Syndicated Systems has specialized in creating compact outfits, allowing you to fit more on your ship than ever before."`
            scene "outfit/large regenerator"
            `"Have you ever found your ship's shield regenerator bulky? Well, worry no more. Syndicated Systems' has developed a novel approach to regeneration technology through our exclusive S line of regenerators. Not only does it save outfit space, but it also repairs your hull as well. Its power needs are somewhat intensive, however, an RT-I Radiothermal can more than handle it, and the combined outfit space is less than what would be needed to achieve comparable shield regeneration with Deep Sky's D line."`
            scene "outfit/ionic afterburner"
            `"Have you ever wanted to fit that big steering engine on your ship, but didn't have the space for it and a thruster as well? Well, with our new Ionic Afterburner, that steering engine is yours. It was designed with fuel in mind, so it is over four times more fuel efficient than the leading competitor."`
            `"Many pilots like to combine outfits from all over the galaxy, however, you will notice how our more heat intensive S line of regenerators and RT-I Radiothermal generators nicely complement our more heat efficient ionic afterburners and X line of ion engines."`
            `You politely thank the quality assurance agent and head out on your way.`
                decline


mission "Neutrality 4: Deep"
    name "Visit Deep Sky"
    description "Visit the main Deep Sky outfitter at <destination> to learn about new technology developed by the Deep."
    to offer
        has "Neutrality 2b: active"
    to complete
        never
    to fail
        has "Neutrality 4b: Deep: declined"
    source
        system Deneb
    destination Asgard

mission "Neutrality 4b: Deep"
    invisible
    outfitter
    to offer
        has "Neutrality 4: Deep: active"
    source Asgard
    on offer
        log "Factions" "Deep" "During the civil war, the Deep mainly produced upgrades over their pre-existing technology. The electron beam is an enhanced heavy laser, the typhoon launcher is an enhanced torpedo launcher, and the catalytic ramscoop is an enhanced ramscoop."
        conversation
            `Deep Sky's customer service is in a separate section from the main outfitter. You enter a very clean, white waiting room. You give your name to the receptionist and have a seat.`
            `After waiting for several minutes, you are called back, and are brought into another clean, white room.`
            `"Hello, welcome to Deep Sky. At Deep Sky, our customers' confidentiality is important to us. How may I help you?"`
            choice
                `"Can you tell me about the Deep's new outfits?"`
                `"I would like to learn more about the Deep's new outfits."`
            `"We would love to talk to you about our outfits!"`
            scene "outfit/electron beam"
            `"First, we have the electron beam, an upgraded form of our broadly popular heavy laser. While the heavy laser is still useful for smaller ships, for those that have the room, the electron beam will allow you to do more damage while still keeping the advantage of stopping as soon as you stop firing. Of course, it has a turret version as well."`
            scene "outfit/typhoon launcher"
            `"Next, is the typhoon launcher. This is an upgraded form of the torpedo launcher. It can shoot three typhoon torpedos at a time, and typhoon torpedos do even more damage than their predecessors."`
            scene "outfit/catalytic ramscoop"
            `"Finally, we've turned to upgrading our ramscoop technology. If you don't know, ramscoops allow you to collect hyperspace fuel from a system's star, allowing you to regain fuel if you run out. This catalytic ramscoop is simply a more space efficient version of our old regular ramscoop. We haven't needed ramscoops in a long time, however, with the supply chain disruptions caused by the Free Worlds rebellion, we decided that our ramscoops just weren't good enough anymore."`
            `"While none of this is novel technology, we wanted to keep our Deep Sky quality while still offering improvements over our pre-existing designs."`
            `"Anything else?"`
            choice
                `"That's it. Thank you."`
                `"No, that's all I wanted to know. Thanks."`
            `"You're welcome. Come back any time. Remember, here at the Deep, we offer you Peace, Prosperity, and Progress."`
            `You are led back out into the main outfitter.`
                decline

